<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ================= SEO Meta Tags ================= -->
    <title>Free PDF Merger - Combine & Merge PDF Files Online | NexaTools</title>
    <meta name="description" content="Combine and merge multiple PDF files into a single document online for free. Drag and drop to reorder your files. Secure, fast, and entirely in-browser with NexaTools.">
    <meta name="keywords" content="pdf merger, combine pdf, merge pdf, join pdf, free pdf merger, online pdf merger, nexatools, combine pdf files">
    <link rel="canonical" href="https://www.nexatools.pro/pdf-merger">

    <!-- ================= Favicon ================= -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon/site.webmanifest">
    <link rel="shortcut icon" href="/assets/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!-- ================= Open Graph / Facebook Meta Tags ================= -->
    <meta property="og:title" content="Free PDF Merger - Combine PDF Files Online | NexaTools">
    <meta property="og:description" content="Combine multiple PDF files into one document for free. Easy drag-and-drop reordering. Secure and private, no uploads required.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.nexatools.pro/pdf-merger">
    <meta property="og:image" content="https://www.nexatools.pro/assets/images/og-image-pdf-merger.png"> <!-- Use an absolute URL for your OG image -->

    <!-- ================= Twitter Card Meta Tags ================= -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Free PDF Merger - Combine PDF Files Online | NexaTools">
    <meta name="twitter:description" content="Combine multiple PDF files into one document for free. Easy drag-and-drop reordering. Secure and private, no uploads required.">
    <meta name="twitter:image" content="https://www.nexatools.pro/assets/images/twitter-image-pdf-merger.png"> <!-- Use an absolute URL for your Twitter image -->

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Styles -->
    <style>
        .header-scrolled {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .dark .header-scrolled {
            background-color: rgba(15, 23, 42, 0.8);
        }
        .drag-over {
            border-color: #10b981; /* brand-green */
            background-color: rgb(16 185 129 / 0.05);
        }
        .dark .drag-over {
            background-color: rgb(16 185 129 / 0.1);
        }
        /* Style for the file list */
        #file-list li {
            background-color: white;
            transition: background-color 0.2s;
        }
        .dark #file-list li {
            background-color: #334155; /* slate-700 */
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c7d2fe; /* brand-blue-light */
        }
        .dark .sortable-ghost {
            background: #374151; /* slate-gray */
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Style for FAQ accordion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .faq-arrow { transform: rotate(180deg); }
    </style>

    <!-- Theme Logic -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { brand: { blue: '#3b82f6', green: '#10b981' } } } } }
    </script>
    
    <!-- ================= JSON-LD Schema Markup ================= -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "SoftwareApplication",
          "name": "PDF Merger",
          "operatingSystem": "Any (Web-based)",
          "applicationCategory": "UtilitiesApplication",
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.9",
            "ratingCount": "4120"
          },
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
          },
          "description": "A free online utility to combine multiple PDF files into a single document. Users can reorder files with drag-and-drop. All processing is done securely in the user's browser.",
          "url": "https://www.nexatools.pro/pdf-merger",
          "publisher": {
            "@type": "Organization",
            "name": "NexaTools",
            "url": "https://www.nexatools.pro"
          }
        },
        {
          "@type": "FAQPage",
          "mainEntity": [
            {
              "@type": "Question",
              "name": "Is this PDF merger tool really free?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, our PDF Merger tool is completely free to use. You can combine as many files as you need without any cost or subscription."
              }
            },
            {
              "@type": "Question",
              "name": "Are my PDF files uploaded to a server?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "No. Your security and privacy are paramount. Our tool processes and merges your PDF files directly in your web browser. Your files never leave your computer."
              }
            },
            {
              "@type": "Question",
              "name": "How do I reorder the files before merging?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "You can easily reorder the files by clicking and dragging them. Use the handle icon on the left of each file name to drag it to your desired position in the list."
              }
            },
            {
              "@type": "Question",
              "name": "Is there a limit to how many files I can merge at once?",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "There is no set limit on the number of files you can merge. However, performance may vary depending on the number of files, their size, and your computer's processing power, as all operations are done locally in your browser."
              }
            }
          ]
        }
      ]
    }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300 flex flex-col min-h-screen">

    <!-- =========== HEADER (NexaTools Design) =========== -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/index.html" class="text-2xl font-bold text-slate-900 dark:text-white">Nexa<span class="text-brand-blue">Tools</span></a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="/index.html" class="text-slate-600 dark:text-slate-300 hover:text-brand-blue dark:hover:text-brand-blue">Home</a>
                <a href="/index.html#tools" class="text-brand-green font-semibold">Tools</a>
                <a href="/about-us.html" class="text-slate-600 dark:text-slate-300 hover:text-brand-blue dark:hover:text-brand-blue">About</a>
                <a href="/contact-us.html" class="text-slate-600 dark:text-slate-300 hover:text-brand-blue dark:hover:text-brand-blue">Contact</a>
            </nav>
            <div class="flex items-center">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zM6.464 16.364l.707-.707a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow pt-24 pb-12">
        <div class="container mx-auto px-4">
            <!-- Tool Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white flex items-center justify-center gap-4">
                    <span class="text-brand-green">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625a3.375 3.375 0 00-3.375 3.375v11.25a3.375 3.375 0 003.375 3.375h12.75a3.375 3.375 0 003.375-3.375V11.25a3.375 3.375 0 00-3.375-3.375h-3.75m-10.5-3.75h.008v.008h-.008v-.008z" /></svg>
                    </span>
                    PDF Merger
                </h1>
                <p class="mt-4 text-lg md:text-xl max-w-2xl mx-auto text-slate-600 dark:text-slate-300">Combine multiple PDF files into one single document. Drag and drop to reorder.</p>
            </div>
            
            <div class="max-w-4xl mx-auto bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 md:p-8">
                
                <!-- Loading State -->
                <div id="loading-state" class="text-center p-8">
                    <svg class="animate-spin h-8 w-8 mx-auto text-brand-green" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 font-semibold text-slate-600 dark:text-slate-300">Loading merge engine...</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center p-8 bg-red-100 dark:bg-red-900/50 rounded-lg">
                    <p class="font-bold text-red-700 dark:text-red-300">Failed to load merge engine.</p>
                    <p class="mt-2 text-red-600 dark:text-red-400">Please check your internet connection and refresh the page.</p>
                </div>

                <!-- Main UI (Upload + Processing) -->
                <div id="main-ui" class="hidden">
                    <!-- File List Area -->
                    <div id="file-list-container" class="min-h-[12rem] bg-slate-100 dark:bg-slate-900/50 rounded-lg p-3">
                        <ul id="file-list" class="space-y-2">
                            <!-- File items will be populated by JS -->
                        </ul>
                        <div id="placeholder" class="text-center text-slate-500 dark:text-slate-400 py-10">
                            <p>Select files to begin...</p>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="add-files-btn" class="w-full sm:w-auto flex-grow bg-slate-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-slate-600 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Add More Files
                        </button>
                        <button id="action-btn" class="w-full sm:w-auto flex-grow bg-brand-green text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                           Merge PDFs
                        </button>
                        <input type="file" id="file-input" class="hidden" accept=".pdf,application/pdf" multiple>
                    </div>
                </div>
            </div>

            <!-- ================= FAQ Section ================= -->
            <section class="max-w-4xl mx-auto mt-16">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-900 dark:text-white">Frequently Asked Questions</h2>
                <div class="space-y-4">
                    <!-- FAQ Item 1 -->
                    <details class="group bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <summary class="flex items-center justify-between cursor-pointer font-semibold text-slate-800 dark:text-slate-100">
                            Is this PDF merger tool really free?
                            <span class="faq-arrow transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </summary>
                        <p class="mt-4 text-slate-600 dark:text-slate-300">Yes, our PDF Merger tool is completely free to use. You can combine as many files as you need without any cost or subscription.</p>
                    </details>
                    <!-- FAQ Item 2 -->
                    <details class="group bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <summary class="flex items-center justify-between cursor-pointer font-semibold text-slate-800 dark:text-slate-100">
                            Are my PDF files uploaded to a server?
                            <span class="faq-arrow transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </summary>
                        <p class="mt-4 text-slate-600 dark:text-slate-300">No. Your security and privacy are paramount. Our tool processes and merges your PDF files directly in your web browser. Your files never leave your computer.</p>
                    </details>
                    <!-- FAQ Item 3 -->
                    <details class="group bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <summary class="flex items-center justify-between cursor-pointer font-semibold text-slate-800 dark:text-slate-100">
                           How do I reorder the files before merging?
                            <span class="faq-arrow transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </summary>
                        <p class="mt-4 text-slate-600 dark:text-slate-300">You can easily reorder the files by clicking and dragging them. Use the handle icon on the left of each file name to drag it to your desired position in the list.</p>
                    </details>
                     <!-- FAQ Item 4 -->
                    <details class="group bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md">
                        <summary class="flex items-center justify-between cursor-pointer font-semibold text-slate-800 dark:text-slate-100">
                           Is there a limit to how many files I can merge at once?
                            <span class="faq-arrow transition-transform duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </summary>
                        <p class="mt-4 text-slate-600 dark:text-slate-300">There is no set limit on the number of files you can merge. However, performance may vary depending on the number of files, their size, and your computer's processing power, as all operations are done locally in your browser.</p>
                    </details>
                </div>
            </section>
        </div>
    </main>

    <!-- =========== FOOTER (NexaTools Design) =========== -->
    <footer class="bg-slate-100 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-700/50 mt-auto">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left space-y-4 md:space-y-0">
                <div>
                    <a href="/index.html" class="text-xl font-bold text-slate-900 dark:text-white">Nexa<span class="text-brand-blue">Tools</span></a>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Simplifying your digital life.</p>
                </div>
                <div class="text-sm text-slate-600 dark:text-slate-400">
                    <p>contact@nexatools.pro</p>
                    <p class="mt-1">© 2025 NexaTools. All Rights Reserved.</p>
                </div>
                <div class="flex space-x-4 text-sm">
                    <a href="/privacy-policy.html" class="text-slate-600 dark:text-slate-400 hover:text-brand-blue dark:hover:text-brand-blue">Privacy Policy</a>
                    <a href="/terms-of-use.html" class="text-slate-600 dark:text-slate-400 hover:text-brand-blue dark:hover:text-brand-blue">Terms of Use</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- External Libraries -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // UI Elements
            const themeToggleBtn = document.getElementById('theme-toggle');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const mainUi = document.getElementById('main-ui');
            const fileListEl = document.getElementById('file-list');
            const fileInput = document.getElementById('file-input');
            const addFilesBtn = document.getElementById('add-files-btn');
            const actionBtn = document.getElementById('action-btn');
            const placeholderEl = document.getElementById('placeholder');
            
            let pdfFiles = []; // Array to hold the File objects in order
            let mergedPdfBlob = null;
            let sortable = null;

            // --- THEME & HEADER ---
            const toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; updateThemeIcons(); };
            const updateThemeIcons = () => { const isDark = document.documentElement.classList.contains('dark'); if(themeToggleBtn){ document.getElementById('theme-toggle-dark-icon').classList.toggle('hidden', !isDark); document.getElementById('theme-toggle-light-icon').classList.toggle('hidden', isDark); } };
            const handleHeaderScroll = () => { const header = document.getElementById('header'); if (header) { window.scrollY > 10 ? header.classList.add('header-scrolled') : header.classList.remove('header-scrolled'); } };
            window.addEventListener('scroll', handleHeaderScroll);
            
            // --- ROBUST LIBRARY INITIALIZATION ---
            const initializeTool = () => {
                let attempts = 0;
                const maxAttempts = 50; // 10 seconds timeout
                
                const checkLibraries = setInterval(() => {
                    if (typeof window.PDFLib !== 'undefined' && typeof window.Sortable !== 'undefined') {
                        clearInterval(checkLibraries);
                        loadingState.classList.add('hidden');
                        mainUi.classList.remove('hidden');
                        setupEventListeners();
                        resetTool();
                    } else {
                        attempts++;
                        if (attempts > maxAttempts) {
                            clearInterval(checkLibraries);
                            loadingState.classList.add('hidden');
                            errorState.classList.remove('hidden');
                        }
                    }
                }, 200);
            };

            // --- FILE HANDLING & UI RENDERING ---
            const handleFiles = (files) => {
                const newFiles = Array.from(files).filter(file => file.type.includes('pdf'));
                if (newFiles.length === 0) return;
                
                pdfFiles.push(...newFiles);
                renderFileList();
            };

            const renderFileList = () => {
                fileListEl.innerHTML = ''; // Clear the list
                
                placeholderEl.classList.toggle('hidden', pdfFiles.length > 0);

                pdfFiles.forEach((file, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-3 border dark:border-slate-600 rounded-md shadow-sm';
                    li.dataset.index = index;
                    li.innerHTML = `
                        <div class="drag-handle text-slate-400 mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" /></svg>
                        </div>
                        <div class="flex-grow truncate text-slate-800 dark:text-slate-200">${file.name}</div>
                        <div class="ml-4 text-sm text-slate-500 dark:text-slate-400">${formatBytes(file.size)}</div>
                        <button class="remove-btn ml-4 text-red-500 hover:text-red-700 dark:hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                    `;
                    fileListEl.appendChild(li);
                });

                // Update merge button state
                actionBtn.disabled = pdfFiles.length < 2;
            };

            // --- MERGING LOGIC ---
            const mergePdfs = async () => {
                if (pdfFiles.length < 2) return;

                actionBtn.disabled = true;
                actionBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Merging...`;

                try {
                    const { PDFDocument } = window.PDFLib;
                    const mergedPdf = await PDFDocument.create();

                    for (const file of pdfFiles) {
                        const pdfBytes = await file.arrayBuffer();
                        const pdfDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });
                        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }

                    const mergedPdfBytes = await mergedPdf.save();
                    mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    
                    actionBtn.textContent = 'Download Merged PDF';
                    actionBtn.classList.replace('bg-brand-green', 'bg-brand-blue');
                    actionBtn.classList.replace('hover:bg-green-600', 'hover:bg-blue-600');
                    actionBtn.disabled = false;

                } catch (error) {
                    handleError(error, "Merging failed");
                }
            };
            
            // --- UTILITY FUNCTIONS ---
            const formatBytes = (bytes, decimals = 2) => {
                if (!+bytes) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
            };
            
            const downloadFile = () => {
                if (!mergedPdfBlob) return;
                const newFileName = `NexaTools-Merged.pdf`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(mergedPdfBlob);
                link.download = newFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            const handleError = (error, message) => {
                console.error(message, error);
                alert(`${message}. One of the PDFs might be encrypted or corrupted.`);
                resetTool();
            };
            
            const resetTool = () => {
                pdfFiles = [];
                mergedPdfBlob = null;
                fileInput.value = '';
                renderFileList();
                actionBtn.disabled = true;
                actionBtn.innerHTML = 'Merge PDFs';
                actionBtn.classList.replace('bg-brand-blue', 'bg-brand-green');
                actionBtn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');
            };

            // --- EVENT LISTENERS ---
            const setupEventListeners = () => {
                themeToggleBtn.addEventListener('click', toggleTheme);
                addFilesBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

                actionBtn.addEventListener('click', () => {
                    if (mergedPdfBlob) {
                        downloadFile();
                    } else {
                        mergePdfs();
                    }
                });
                
                // Event delegation for remove buttons
                fileListEl.addEventListener('click', (e) => {
                    const removeButton = e.target.closest('.remove-btn');
                    if (removeButton) {
                        const listItem = removeButton.closest('li');
                        const indexToRemove = parseInt(listItem.dataset.index, 10);
                        pdfFiles.splice(indexToRemove, 1);
                        renderFileList();
                    }
                });

                // Initialize Sortable.js for drag-and-drop
                sortable = new Sortable(fileListEl, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        // Reorder the pdfFiles array to match the new UI order
                        const [movedItem] = pdfFiles.splice(evt.oldIndex, 1);
                        pdfFiles.splice(evt.newIndex, 0, movedItem);
                        // Re-render to update data attributes
                        renderFileList();
                    },
                });
            };
            
            // --- INITIALIZATION ---
            updateThemeIcons();
            initializeTool();
        });
    </script>
</body>
</html>